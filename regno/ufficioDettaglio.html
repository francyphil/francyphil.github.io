<!doctype html>
<html lang="it">
  <head>
    <link rel="stylesheet" href="/common-bg.css" />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dettagli Ufficio</title>
    <script src="/favicon-loader.js"></script>
    <link rel="stylesheet" href="/navbar.css" />
    <style>
      body {
        font-family: sans-serif;
        margin: 0;
        padding: 0;
        margin-top: 55px;
      }

      .office-header {
        background-color: #f0f0f0;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 30px;
      }

      .office-header h1 {
        margin: 0 0 10px 0;
      }

      .office-header p {
        margin: 5px 0;
        font-size: 16px;
      }

      /* Tabella targhette */
      .table-wrapper {
        overflow-x: auto;
        margin-top: 20px;
      }

      /* rendi la tabella larga quanto il contenitore permette */
      table {
        border-collapse: collapse;
        width: 100%;
        max-width: 100%;
        table-layout: fixed;
      }

      th,
      td {
        border: 1px solid #ccc;
        padding: 5px 10px;
        text-align: left;
        white-space: nowrap;
      }

      th {
        background-color: #f0f0f0;
      }

      tr:nth-child(even) {
        background-color: #f9f9f9;
      }

      tr:hover {
        background-color: #f0f0f0;
      }

      a {
        color: #0066cc;
        text-decoration: none;
      }

      a:hover {
        text-decoration: underline;
      }

      .no-results {
        text-align: center;
        padding: 40px;
        color: #999;
        font-size: 18px;
      }

      .stats {
        margin-top: 20px;
        padding: 15px;
        background-color: #e8f4f8;
        border-left: 4px solid #0066cc;
        border-radius: 4px;
      }
    </style>
  </head>
  <body>
    <div class="content-container">
      <div class="office-header">
        <h1 id="officeTitle">Ufficio</h1>
        <p id="officeInfo"></p>
      </div>

      <!-- Blocchetto: Datari usati (icone _circle) -->
      <div id="datariBlock" style="display: none; margin-bottom: 18px">
        <strong>Datari usati per gli annulli:</strong>
        <div
            id="datariList"
          style="
            margin-top: 8px;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: center;
            align-content: flex-start;
            justify-content: center;
          "
        ></div>
      </div>

      <!-- Contenitore grafico: anni x datari -->
      <div id="datariChartBlock" style="display:none; margin-top:18px; text-align:center;">
        <strong>Uso dei datari nel tempo</strong>
        <div id="datariChart" style="margin-top:8px; text-align:center;"></div>
      </div>

      <div class="stats">
        <strong>Targhette trovate:</strong> <span id="statsCount">0</span>
      </div>

   

      <div class="table-wrapper">
        <table id="tableTarghette">
          <colgroup>
              <col id="colAnno" style="width:16%">
              <col id="colTipo" style="width:12%">
              <col id="colUfficio" style="width:12%">
              <col id="colDescr" style="width:60%">
          </colgroup>
          <thead>
            <tr>
              <th>Anno</th>
              <th>Targhetta Tipo</th>
              <th>Targhetta Ufficio</th>
              <th>Descrizione</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>

      <div id="noResults" class="no-results" style="display: none">
        Nessuna targhetta trovata per questo ufficio.
      </div>

      <script src="/navbar.js"></script>
      <script>
        // Estrae i parametri dall'URL
        function getURLParams() {
          const params = new URLSearchParams(window.location.search);
          return {
            denominazione: params.get("denominazione"),
            localita: params.get("localita"),
          };
        }

        // Carica e filtra i dati
        async function loadOfficeDetails() {
          const { denominazione, localita } = getURLParams();

          if (!denominazione || !localita) {
            document.getElementById("officeTitle").textContent =
              "Ufficio non trovato";
            return;
          }

          // Aggiorna titolo
          document.getElementById("officeTitle").textContent =
            `${denominazione} - ${localita}`;
          document.getElementById("officeInfo").textContent =
            `Elenco targhette ordinate per anno`;

          try {
            // Carica il JSON
            const response = await fetch("targhetteRegno.json");
            const data = await response.json();

            // Filtra per denominazione e localita
            const filtered = data.filter(
              (item) =>
                item["Denominazione ufficio"] === denominazione &&
                item["Località"] === localita,
            );

            // Ordina per anno (ascendente)
            filtered.sort((a, b) => {
              if (a.Anno === b.Anno) {
                return a["Targhetta Ufficio"] - b["Targhetta Ufficio"];
              }
              return a.Anno - b.Anno;
            });

            // Mostra risultati
            if (filtered.length === 0) {
              document.getElementById("noResults").style.display = "block";
              document.getElementById("tableTarghette").style.display = "none";
              document.getElementById("statsCount").textContent = "0";
            } else {
              const tbody = document.getElementById("tableBody");
              tbody.innerHTML = "";

              filtered.forEach((item) => {
                const tr = document.createElement("tr");

                const tdAnno = document.createElement("td");
                tdAnno.textContent = item.Anno;

                const tdTipo = document.createElement("td");
                tdTipo.textContent = item["Targhetta Tipo"];

                const tdUfficio = document.createElement("td");
                tdUfficio.textContent = item["Targhetta Ufficio"];

                const tdDescrizione = document.createElement("td");
                tdDescrizione.textContent = item["Descrizione"];

                tr.appendChild(tdAnno);
                tr.appendChild(tdTipo);
                tr.appendChild(tdUfficio);
                tr.appendChild(tdDescrizione);

                tbody.appendChild(tr);
              });

              document.getElementById("statsCount").textContent =
                filtered.length;
              document.getElementById("noResults").style.display = "none";
              document.getElementById("tableTarghette").style.display = "table";
            }

            // Mostra i datari usati per gli annulli (se presenti)
            renderDatari(filtered);
            // Disegna anche il grafico anni x datari
            renderChart(filtered);
          } catch (error) {
            console.error("Errore caricamento dati:", error);
            document.getElementById("officeTitle").textContent =
              "Errore caricamento dati";
          }
        }

        // Mostra i datari unici usati nel set filtrato. Usa la cartella regno/imgDatariRegno
        function renderDatari(records) {
          const listContainer = document.getElementById("datariList");
          const block = document.getElementById("datariBlock");
          listContainer.innerHTML = "";

          const seen = new Set();
          records.forEach((r) => {
            const link = (r.linkDatario || "").trim();
            if (!link) return;
            if (seen.has(link)) return;
            seen.add(link);

            // costruisci nome con _circle prima dell'estensione
            const m = link.match(/^(.*)\.(jpeg|jpg|png)$/i);
            let circleName = link;
            if (m) {
              circleName = `${m[1]}_circle.${m[2]}`;
            } else {
              circleName = `${link}_circle`;
            }

            // wrapper verticale per immagine + label
            const wrapper = document.createElement("div");
            wrapper.style.display = "flex";
            wrapper.style.flexDirection = "column";
            wrapper.style.alignItems = "center";
            wrapper.style.maxWidth = "200px";
            wrapper.style.margin = "0"; /* spacing controlled by container gap */
            wrapper.style.flex = "0 0 auto";

            const img = document.createElement("img");
            img.src = `imgDatariRegno/${circleName}`;
            img.alt = link;
              img.style.height = "200px";
              img.style.maxWidth = "200px";
              img.style.display = "block";
              img.style.margin = "0 auto";
            img.style.borderRadius = "100px"; /*L'immagine è di 200px, ci metto un contorno da 100 in modo da far vedere solo il datario*/
            img.style.border = "1px solid #ddd";
            img.style.objectFit = "contain";

            // se l'immagine non esiste, rimuoviamo l'intero wrapper
            img.onerror = () => wrapper.remove();

            // click apre la versione completa (senza _circle) se presente
            const a = document.createElement("a");
            //a.href = `imgDatariRegno/${link}`; //qui un eventuale link per una pagina secifica del datario
            a.target = "_blank";
            a.appendChild(img);

            // label con il codice Datario (se presente)
            const datarioCode = (r.Datario || "").trim();
            if (datarioCode) {
              const lbl = document.createElement("div");
              lbl.textContent = datarioCode;
              lbl.style.marginTop = "6px";
              lbl.style.fontSize = "20px"; /* aumentata del 30% rispetto a 12px */
              lbl.style.color = "#333";
              lbl.style.textAlign = "center";
              wrapper.appendChild(a);
              wrapper.appendChild(lbl);
            } else {
              wrapper.appendChild(a);
            }

            listContainer.appendChild(wrapper);
          });

          if (seen.size > 0) {
            block.style.display = "block";
          } else {
            block.style.display = "none";
          }
        }

            // Disegna la griglia anni x datari: quadratino se il datario è stato usato in quell'anno
            function renderChart(records) {
              const chartBlock = document.getElementById('datariChartBlock');
              const container = document.getElementById('datariChart');
              container.innerHTML = '';

              // ricava codici Datario unici e gli anni
              const datari = Array.from(new Set(records.map(r => (r.Datario||'').trim()).filter(Boolean))).sort();
              let yearsPresent = Array.from(new Set(records.map(r => r.Anno).filter(y => Number.isFinite(y)))).sort((a,b)=>a-b);
              // assicurati di includere tutti gli anni compresi tra primo e ultimo
              let years = [];
              if (yearsPresent.length > 0) {
                const minY = yearsPresent[0];
                const maxY = yearsPresent[yearsPresent.length-1];
                for (let y = minY; y <= maxY; y++) years.push(y);
              }

              if (datari.length === 0 || years.length === 0) {
                chartBlock.style.display = 'none';
                return;
              }
              chartBlock.style.display = 'block';

              const cell = 16;
              const left = 140;
              const top = 20;
              const gridWidth = years.length * cell;
              const gridHeight = datari.length * cell;
              const width = left + gridWidth + 20;
              const height = top + gridHeight + 60;

              const svgNS = 'http://www.w3.org/2000/svg';
              const svg = document.createElementNS(svgNS, 'svg');
              svg.setAttribute('width', width);
              svg.setAttribute('height', height);
              svg.setAttribute('viewBox', `0 0 ${width} ${height}`);
              svg.setAttribute('style', 'display:block; margin:0 auto;');

              // y labels (datari) - vertically centered in cell
              datari.forEach((d, i) => {
                const y = top + i * cell + cell/2;
                const text = document.createElementNS(svgNS, 'text');
                text.setAttribute('x', left - 12);
                text.setAttribute('y', y);
                text.setAttribute('text-anchor', 'end');
                text.setAttribute('font-size', '15px');
                text.setAttribute('dominant-baseline', 'middle');
                text.textContent = d;
                svg.appendChild(text);
              });

              // disegna griglia verticale (linee sottili) e orizzontale (più spesse)
              // verticali
              for (let j=0;j<=years.length;j++){
                const xline = left + j*cell;
                const line = document.createElementNS(svgNS,'line');
                line.setAttribute('x1', xline);
                line.setAttribute('y1', top);
                line.setAttribute('x2', xline);
                line.setAttribute('y2', top + gridHeight);
                line.setAttribute('stroke', '#ddd');
                line.setAttribute('stroke-width', '1');
                svg.appendChild(line);
              }
              // orizzontali (più spesse)
              for (let i=0;i<=datari.length;i++){
                const yline = top + i*cell;
                const hline = document.createElementNS(svgNS,'line');
                hline.setAttribute('x1', left);
                hline.setAttribute('y1', yline);
                hline.setAttribute('x2', left + gridWidth);
                hline.setAttribute('y2', yline);
                hline.setAttribute('stroke', '#bbb');
                hline.setAttribute('stroke-width', '2');
                svg.appendChild(hline);
              }

              // x labels (years) - include anche gli anni vuoti, centered in cell
              years.forEach((yr, j) => {
                const x = left + j * cell + cell/2;
                const baseY = top + datari.length * cell + cell/2;
                const text = document.createElementNS(svgNS, 'text');
                text.setAttribute('x', x - 12);
                text.setAttribute('y', baseY);
                text.setAttribute('font-size', '15px');
                text.setAttribute('text-anchor', 'middle');
                text.setAttribute('dominant-baseline', 'middle');
                text.setAttribute('transform', `rotate(-90 ${x} ${baseY})`);
                text.textContent = yr;
                svg.appendChild(text);
              });

              // draw squares
              datari.forEach((d, i) => {
                years.forEach((yr, j) => {
                  const used = records.some(r => ((r.Datario||'').trim() === d) && r.Anno === yr);
                  if (used) {
                    const rect = document.createElementNS(svgNS, 'rect');
                    const x = left + j * cell + 1;
                    const y = top + i * cell + 1;
                    rect.setAttribute('x', x );
                    rect.setAttribute('y', y );
                    rect.setAttribute('width', cell - 2);
                    rect.setAttribute('height', cell - 2);
                    rect.setAttribute('fill', '#333');
                    rect.setAttribute('title', `${d} • ${yr}`);
                    svg.appendChild(rect);
                  }
                });
              });

              container.appendChild(svg);
            }

        // Carica quando il DOM è pronto
        document.addEventListener("DOMContentLoaded", loadOfficeDetails);

        // Inizializza i controlli della tabella
        document.addEventListener('DOMContentLoaded', () => {
          const apply = document.getElementById('applyPct');
          apply.addEventListener('click', applyTableWidths);
        });

        function applyTableWidths() {
          const a = Number(document.getElementById('pctAnno').value) || 0;
          const t = Number(document.getElementById('pctTipo').value) || 0;
          const u = Number(document.getElementById('pctUfficio').value) || 0;
          const d = Number(document.getElementById('pctDescr').value) || 0;
          const sum = a + t + u + d;
          // se la somma è 0, evita divisione per 0
          if (sum <= 0) return;
          // normalizza perchè la tabella usa percentuali rispetto al container
          const norm = (v) => Math.round((v / sum) * 10000) / 100; // due decimali

          document.getElementById('colAnno').style.width = norm(a) + '%';
          document.getElementById('colTipo').style.width = norm(t) + '%';
          document.getElementById('colUfficio').style.width = norm(u) + '%';
          document.getElementById('colDescr').style.width = norm(d) + '%';
        }
      </script>
    </div>

    <link rel="stylesheet" href="/footer.css" />
    <script src="/footer.js"></script>
    <div id="footerContainer"></div>
    <script>
      fetch("/footer.html")
        .then((res) => res.text())
        .then((html) => {
          document.getElementById("footerContainer").innerHTML = html;
        });
    </script>
  </body>
</html>
